"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}!function(e,t,i){var r,n,s,o,a,u=t.Mixin,l=t.String,p=t.computed,c=t.get,h=t.set,d=t.run,f={NONE:0,VALID:1,INVALID:2,DELETED:4,UPLOADED:8,FAILED:16},m={PATCH:"PATCH",POST:"POST",PUT:"PUT"},g="droplet/add-files",y=function(e){return"function"==typeof Array.from?Array.from(e):Array.prototype.slice.call(e)},v=t.Service.extend(t.Evented,{publish:function(){this.trigger.apply(this,arguments)},subscribe:function(){this.on.apply(this,arguments)},unsubscribe:function(){this.off.apply(this,arguments)}});t.Application.initializer({name:"load-services",initialize:function(e){var t=v.create();e.register("event-bus:current",t,{instantiate:!1}),e.inject("component","DropletEventBus","event-bus:current"),e.inject("controller","DropletEventBus","event-bus:current")}});var D=t.Object.extend({init:function(){this.statusType=f.NONE},getMIMEType:function(){return this.file.type||""},getFileSize:function(){return void 0!==this.file.size?this.file.size:1/0},setStatusType:function(e){this.set("statusType",Number(e))}}),b={PUSH:"push",SET:"set"},A={requestMethod:m.POST,maximumSize:1/0,maximumValidFiles:1/0,uploadImmediately:!1,includeXFileSize:!0,useArray:!1,mimeTypes:["image/jpeg","image/jpg","image/gif","image/png","image/tiff","image/bmp"],requestHeaders:{},requestPostData:{}},E=l.w("files.length files.@each.statusType"),F={URL_REQUIRED:"Droplet: You must specify the URL parameter when constructing your component."};e.Droplet={url:function(){throw new Error(F.URL_REQUIRED)},model:D,options:{},hooks:{},files:[],statusTypes:f,init:function(){var e=this;h(this,"files",[]);var i=t.merge({},this.get("hooks"));h(this,"hooks",i);var r=t.merge({},A);t.merge(r,this.get("options")),h(this,"options",r),this.DropletEventBus&&this.DropletEventBus.subscribe(g,this,function(t){for(var i=arguments.length,r=Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];t&&t!==e||e.send.apply(e,["prepareFiles"].concat(r))}),this._super()},willDestroy:function(){this._super(),this.DropletEventBus&&this.DropletEventBus.unsubscribe(g,this);var e=this.get("lastRequest");e&&(delete e.upload.onprogress,delete e.upload.onload,delete e.upload.onerror,this.send("abortUpload"))},invokeHook:function(e){for(var i=this,r=arguments.length,n=Array(r>1?r-1:0),s=1;s<r;s++)n[s-1]=arguments[s];var o=c(this,"hooks")[e]||function(){};t.run(function(){return o.apply(i,n)})},uploadStatus:p(function(){return{uploading:!1,percentComplete:0,error:!1}}),validFiles:(r=p(function(){return this.getFiles(f.VALID)})).property.apply(r,_toConsumableArray(E)),invalidFiles:(n=p(function(){return this.getFiles(f.INVALID)})).property.apply(n,_toConsumableArray(E)),uploadedFiles:(s=p(function(){return this.getFiles(f.UPLOADED)})).property.apply(s,_toConsumableArray(E)),deletedFiles:(o=p(function(){return this.getFiles(f.DELETED)})).property.apply(o,_toConsumableArray(E)),requestSize:(a=p(function(){return c(this,"validFiles").reduce(function(e,t){return e+t.getFileSize()},0)})).property.apply(a,_toConsumableArray(E)),getFiles:function(e){return e?this.files.filter(function(t){return t.statusType&e}):this.files},isValid:function(e){var i=this;if(!(e instanceof t.Object))return!1;return function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return function(e){return t.reverse().every(function(t){return t(e)})}}(function(e){return function(){var t=i.get("options.mimeTypes").some(function(e){return e instanceof RegExp}),r=c(i,"options.mimeTypes");return t?r.some(function(t){var i=t===e,r=!!e.match(t);return i||r}):!!~r.indexOf(e)}}(e.getMIMEType()),function(e){return function(){return e<=Number(c(i,"options.maximumSize"))}}(e.getFileSize()))(e)},getFormData:function(){var t=new e.FormData,i=this.get("options.useArray")?"file[]":"file",r=this.get("options.requestPostData");return c(this,"validFiles").map(function(e){return e.file}).forEach(function(e){t.append(i,e)}),Object.keys(r).forEach(function(e){t.append(e,r[e])}),t},addProgressListener:function(e){var t=this;e.addEventListener("progress",function(e){if(e.lengthComputable){var i=e.loaded/c(t,"requestSize")*100;h(t,"uploadStatus.percentComplete",Math.round(i))}})},getRequest:function(){var e=this,i=function(e){return"function"==typeof e}(c(this,"url"))?c(this,"url").apply(this):c(this,"url"),r=c(this,"options.requestMethod")||"POST",n=this.getFormData(),s=t.merge({},this.get("options.requestHeaders"));c(this,"options.includeXFileSize")&&(s["X-File-Size"]=this.get("requestSize"));var o=t.$.ajax({url:i,method:r,headers:s,data:n,processData:!1,contentType:!1,xhr:function(){var i=t.$.ajaxSettings.xhr();return e.addProgressListener(i.upload),h(e,"lastRequest",i),i}});return h(this,"lastResolver",o),o},actions:{uploadFiles:function(){var e=this;this.invokeHook("beforeUpload");var i=c(this,"files").filter(function(e){return e.statusType&f.VALID}),r=this.getRequest();h(this,"abortedUpload",!1),h(this,"uploadStatus.percentComplete",0),h(this,"uploadStatus.uploading",!0),h(this,"uploadStatus.error",!1);var n=function(t,n){e.invokeHook("promiseResolver",t,n,i),r.done(t).fail(n)},s=function(t){e.invokeHook("didUpload",t),i.map(function(e){return e.setStatusType(f.UPLOADED)})},o=function(t){var i=t.request,r=t.textStatus,n=t.errorThrown,s=t.responseText,o=t.responseJSON;r=r||s,i=i||o,!0!==c(e,"abortedUpload")&&h(e,"uploadStatus.error",{request:i,textStatus:r,errorThrown:n}),e.invokeHook("rejected",i,r,n)},a=function(){h(e,"uploadStatus.uploading",!1),e.invokeHook("didComplete")};return new t.RSVP.Promise(n).then(s,o).finally(a)},abortUpload:function(){var e=c(this,"lastResolver");e&&c(this,"uploadStatus.uploading")&&(h(this,"abortedUpload",!0),e.abort(),h(this,"uploadStatus.uploading",!1))},mimeTypes:function(e){(arguments.length>1&&void 0!==arguments[1]?arguments[1]:b.PUSH)===b.SET&&h(this,"options.mimeTypes",[]),e=Array.isArray(e)?e:[e];var t=[].concat(_toConsumableArray(c(this,"options.mimeTypes")),_toConsumableArray(e));h(this,"options.mimeTypes",t)},addFiles:function(){for(var e=this,i=arguments.length,r=Array(i),n=0;n<i;n++)r[n]=arguments[n];var s=r.map(function(i){var r=e.get("validFiles.length")===e.get("options.maximumValidFiles");if(i instanceof t.Object){var n=e.isValid(i)&&!r?f.VALID:f.INVALID;return d(function(){return i.setStatusType(n)}),c(e,"files").pushObject(i),i}}).filter(function(e){return void 0!==e});s.length&&this.invokeHook.apply(this,["didAdd"].concat(_toConsumableArray(s))),this.get("options.uploadImmediately")&&this.getFiles(f.VALID).length>0&&this.send.apply(this,["uploadFiles"].concat(_toConsumableArray(s)))},prepareFiles:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];t=y(t);var r=t.reduce(function(e,t){var i=D.create({file:t});return e.push(i),e},[]);return this.send.apply(this,["addFiles"].concat(_toConsumableArray(r))),r},deleteFiles:function(){for(var e=this,t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];var n=i.map(function(t){if(!!~c(e,"files").indexOf(t))return t.setStatusType(f.DELETED),t}).filter(function(e){return void 0!==e});n.length&&this.invokeHook.apply(this,["didDelete"].concat(_toConsumableArray(n)))},clearFiles:function(){var e=this;[].concat(_toConsumableArray(this.get("validFiles")),_toConsumableArray(this.get("invalidFiles"))).forEach(function(t){return e.send("deleteFiles",t)})}}};var S=function(e){e.preventDefault(),e.stopPropagation()};e.Droplet.Area=u.create({classNames:["droppable"],drop:function(e){return S(e),this.handleFiles(e.dataTransfer.files)},handleFiles:function(e){var t;return this.DropletEventBus&&(t=this.DropletEventBus).publish.apply(t,[g,this.get("ctx")].concat(_toConsumableArray(y(e)))),e},dragEnter:S,dragOver:S,dragLeave:S}),e.Droplet.Preview=u.create({tagName:"img",attributeBindings:["src"],reader:i,image:{file:{type:""}},isImage:function(e){return!!e.type.match(/^image\//i)},didInsertElement:function(){var e=this,t=this.get("reader"),i=new t,r=c(this,"image.file");if(!this.isImage(r))return void this.destroy();i.addEventListener("load",d.bind(this,function(t){!0!==e.get("isDestroyed")&&h(e,"src",t.target.result)})),i.readAsDataURL(r)}}),e.Droplet.MultipleInput=u.create({tagName:"input",classNames:"files",attributeBindings:["disabled","name","type","multiple"],type:"file",multiple:"multiple",change:function(){var e=this.get("element").files;this.handleFiles(e)},handleFiles:function(e){var t;this.DropletEventBus&&(t=this.DropletEventBus).publish.apply(t,[g,this.get("ctx")].concat(_toConsumableArray(y(e))))}}),e.Droplet.SingleInput=u.create(e.Droplet.MultipleInput,{multiple:!1}),e.Droplet.METHOD=m}(window,window.Ember,window.FileReader);